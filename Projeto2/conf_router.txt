##VER COM O PROF QUAL GAMA DE PORTS É OK PARA O MODO PASSIVO DO FTP
#a tranferecia das listas funciona, mas nao consegui testar a tranferencia/alteracao para o server, as vindas dele funcionam, porque da erro de privilegios no lado do server)
#no ativo o download para o cliente tb n da



clear
sudo systemctl stop firewalld 
ip route flush all
iptables -F
iptables -F INPUT
iptables -F OUTPUT
iptables -F FORWARD
iptables -t nat -F POSTROUTING
iptables -t nat -F PREROUTING
ip addr add 172.16.1.254/24 dev enp0s8
ip addr add 10.254.0.254/24 dev enp0s9
ip addr add 50.40.30.254/24 dev enp0s10			
route add -net 10.254.0.0/24 gw 10.254.0.254	
route add -net 172.16.1.0/24 gw 172.16.1.254
route add -net 50.40.30.0/24 gw 50.40.30.254
sysctl -w net.ipv4.ip_forward=1
iptables -P INPUT DROP							 
iptables -P OUTPUT ACCEPT
iptables -P FORWARD DROP


####ROUTER -> PUBLICA ------ PRIVADA -> ROUTER ------ DMZ -> ROUTER
#permitir a entrada de pacotes para estabelecer e sincronicar ligaçoes (ACK e SYN)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
####DNS PORT(53)##############################################################################################################
iptables -A INPUT 			-p tcp -s 172.16.1.0/24 -d 172.16.1.254 --sport 53 -j ACCEPT 

####SSH PORT(22)##############################################################################################################
iptables -A INPUT 			-p tcp -s 10.254.0.0/24 -d 10.254.0.254  --dport 22 -j ACCEPT 
iptables -A INPUT 			-p tcp -s 50.40.30.1 	-d 50.40.30.254  --dport 22 -j ACCEPT 	#só para o vpn-gw da DMZ



###############################################################################################################################################################################################################



####PEDIDOS PRIVADA -> PUBLICA  (NAT)
####DNS PORT(53)##############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 53 -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 53 -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 53 -j SNAT --to-source 172.16.1.254

####HTTP PORT(80)#############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport http -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport http -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport http -j SNAT --to-source 172.16.1.254

####HTTPS PORT(443)###########################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport https -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport https -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport https -j SNAT --to-source 172.16.1.254

####SSH PORT(22)##############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 22 -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 22 -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 22 -j SNAT --to-source 172.16.1.254

####FTP ATIVO (the server assigns a port and the IP address will be the same as the FTP client making the request)###############################################################################################
#premitir que um pedido de FTP seja enviado e respondido
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 21 	-j ACCEPT
#premitir que o server use o seu port padrão de tranferencia de data em FTP
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 20 	-j ACCEPT
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 20:21 	-j SNAT --to-source 172.16.1.254

####FTP PASSIVE MODE#####################################################################################################
#premitir que um pedido de FTP seja enviado e respondido
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 21 -j ACCEPT
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 21 -j ACCEPT
#premitir que o port escolhido pelo server para trans data, seja usado (ao inves do padrao 20)
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 1024:65535 -j ACCEPT
#alterar os ip entre redes antes de criar a ligacao e apos estar estabelecida
iptables -t nat -A POSTROUTING  -p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 21 		-j SNAT --to-source 172.16.1.254
iptables -t nat -A POSTROUTING  -p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 1024:65535 -j SNAT --to-source 172.16.1.254

#NOTA:para se conseguir alterar algo no server temos de ir a esse diretorio dar permissoes de escrita a anonimos(se fizermos login com um claro, USEI O /usr/games/)
