
clear
sudo systemctl stop firewalld 
ip route flush all
iptables -F
iptables -F INPUT
iptables -F OUTPUT
iptables -F FORWARD
iptables -t nat -F POSTROUTING
iptables -t nat -F PREROUTING
ip addr add 172.16.1.254/24 dev enp0s8
ip addr add 10.254.0.254/24 dev enp0s9
ip addr add 50.40.30.254/24 dev enp0s10			
route add -net 10.254.0.0/24 gw 10.254.0.254	
route add -net 172.16.1.0/24 gw 172.16.1.254
route add -net 50.40.30.0/24 gw 50.40.30.254
sysctl -w net.ipv4.ip_forward=1
iptables -P INPUT DROP							 
iptables -P OUTPUT ACCEPT
iptables -P FORWARD DROP


####ROUTER -> PUBLICA ------ PRIVADA -> ROUTER ------ DMZ -> ROUTER
#permitir a entrada de pacotes para estabelecer e sincronicar ligaçoes (ACK e SYN)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
####DNS PORT(53)##############################################################################################################
iptables -A INPUT 			-p tcp -s 172.16.1.0/24 -d 172.16.1.254 --sport 53 -j ACCEPT 

####SSH PORT(22)##############################################################################################################
iptables -A INPUT 			-p tcp -s 10.254.0.0/24 -d 10.254.0.254  --dport 22 -j ACCEPT 
iptables -A INPUT 			-p tcp -s 50.40.30.1 	-d 50.40.30.254  --dport 22 -j ACCEPT 	#só para o vpn-gw da DMZ



############################################################################################################################################################################################################################

####PEDIDOS PRIVADA -> PUBLICA
####DNS PORT(53)##############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 53 -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 53 -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 53 -j SNAT --to-source 172.16.1.254

####HTTP PORT(80)#############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport http -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport http -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport http -j SNAT --to-source 172.16.1.254

####HTTPS PORT(443)###########################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport https -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport https -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport https -j SNAT --to-source 172.16.1.254

####SSH PORT(22)##############################################################################################################
iptables -A FORWARD 			-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 22 -j ACCEPT 
iptables -A FORWARD 			-p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 22 -j ACCEPT    						
iptables -t nat -A POSTROUTING 	-p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 22 -j SNAT --to-source 172.16.1.254






#AINDA FALTA O FTP E COMO O TESTAR NOS 2 MODOS
####FTP ATIVO (the server assigns a port and the IP address will be the same as the FTP client making the request)##############################################################################################################
####FTP PASSIVO (the FTP server waits for the FTP client to send it a port and IP address to connect to)##############################################################################################################



####FTP ACTIVE MODE PORT (21)######################################################################################################
#Allow outbound connections to FTP server on port 21 for active mode FTP
iptables -A FORWARD -p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 21 -j ACCEPT
iptables -A FORWARD -p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 21 -j ACCEPT
#Allow outbound connections to FTP server for data transfer in active mode
iptables -A FORWARD -p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --sport 1024:65535 --tcp-flags SYN SYN -j ACCEPT
iptables -A FORWARD -p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --dport 1024:65535 --tcp-flags SYN,ACK SYN,ACK -j ACCEPT

####FTP PASSIVE MODE PORT#####################################################################################################
#Allow inbound connections to FTP server on a range of ports for data transfer in passive mode
iptables -A FORWARD -p tcp -s 10.254.0.0/24 -d 172.16.1.0/24 --dport 1024:65535 --tcp-flags SYN SYN -j ACCEPT
iptables -A FORWARD -p tcp -d 10.254.0.0/24 -s 172.16.1.0/24 --sport 1024:65535 --tcp-flags SYN,ACK SYN,ACK -j ACCEPT

